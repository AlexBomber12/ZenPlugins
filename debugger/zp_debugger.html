<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Zenmoney Plugin test</title>
<script type="text/javascript">
    onmessage=function(e){if(!e)return;function getFileData(t){var e=new XMLHttpRequest;try{return e.open("GET",t,!1),e.send(),e.responseText&&e.responseText.length>0?e.responseText:null}catch(n){return null}}function ZPAPIError(t,e,n){t=t||"";var r;return this instanceof ZPAPIError?(r=this,r.toString=function(){return(this.fatal?"F":" ")+" "+(this.allowRetry?"R":" ")+" "+this.message},t instanceof ZPAPIError?(r.message=t.message,r.allowRetry=t.allowRetry,r.fatal=t.fatal):r.message=void 0!==t.message?t.message:t.toString()):t instanceof ZPAPIError?r=t:(r=new ZPAPIError(t),(void 0!==t.stack||void 0!==t.stacktrace)&&(r.stack=t.stack||t.stacktrace)),(void 0===r.fatal||void 0!==n)&&(r.fatal=!!n),(void 0===r.allowRetry||void 0!==e)&&(r.allowRetry=!!e),r}function ZPAPI(t,e){"use strict";function n(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}function r(t){for(var e=(new Date).getTime(),n=0;3e7>n;n++);var o=(new Date).getTime();t>o-e&&r(t-o+e)}function o(t){var e="";for(var n in t)""!=e&&(e+="&"),e+=n+"="+encodeURIComponent(t[n]);return e}function a(t){return t.replace(/\s+/g," ").trim()}function i(t){return["day","month","year"].indexOf(t)<0?null:t}function s(t){if(!t)return null;var e=0;if(t instanceof Date)e=t.getTime();else if("number"==typeof t)e=t;else if("string"==typeof t){if(t=t.trim(),0===t.length)return null;try{var n=t.match(/(\d{2})\.(\d{2})\.(\d{4})/);n?(e=Date.parse(n[3]+"-"+n[2]+"-"+n[1]),isNaN(e)&&(e=0)):e=0}catch(r){e=0}if(0==e)try{e=Date.parse(t),isNaN(e)&&(e=0)}catch(r){e=0}if(0==e)try{e=parseFloat(t),isNaN(e)&&(e=0)}catch(r){e=0}}return e>=1e10&&(e/=1e3),e>0?e:null}function c(t){if("function"==typeof t)try{return t()}catch(e){t=e}if(t&&(A=t.toString(),v))throw ZPAPIError(t);return null}function u(t,e,n,r){var a=new XMLHttpRequest;a.withCredentials=!0,a.open(t,e,!1),a.setRequestHeader(p,"true");var i=null,s="utf-8",u=1;if(n)for(var f in n){if(r&&"string"!=typeof r){var l=f.toLowerCase();if(l.indexOf("content-type")>=0){l=n[f].toLowerCase();var d=l.lastIndexOf("charset=");d>=0&&d<l.length?(s=l.substring(d),i=l.substring(0,l.lastIndexOf(";",d-8))):i=l,l.indexOf("json")>=0?u=2:l.indexOf("xml")>=0&&(u=3);continue}}a.setRequestHeader(p+f,n[f])}if(r&&"string"!=typeof r)switch(i||(i="application/x-www-form-urlencoded"),s||(s="utf-8"),a.setRequestHeader(p+"Content-Type",i+"; charset="+s),u){case 1:r=o(r);break;case 2:r=JSON.stringify(r);break;case 3:return c("XML type not supported"),null}return c(function(){return a.send(r),O=a,a.responseText})}function f(t){var e=m[t];if(e)return e;e={};var n=t,r=t.indexOf("#");if(r>=0){n=t.substring(0,r);var o=t.indexOf("#",r+1);o>=0?(e.instrument=t.substring(r+1,o),e.syncID=t.substring(o+1).split(",").map(a).filter(function(t){return t.length>0})):e.instrument=t.substring(r+1)}return n=a(n),["cash","card","ccard","checking","loan","deposit","emoney"].indexOf(n)>=0?(e.type=n,m[t]=e):e=null,e}function l(t){var e=t.id||"(null)";if("number"!=typeof t.income||t.income<0||"number"!=typeof t.outcome||t.outcome<0)return c("Wrong transaction "+e+". Income and outcome should be non-negative");if(0==t.income&&0==t.outcome)return c("Wrong transaction "+e+". Transaction should have either income > 0 or outcome > 0");if(void 0!==t.opIncome&&null!==t.opIncome&&("number"!=typeof t.opIncome||t.opIncome<0)||void 0!==t.opOutcome&&null!==t.opOutcome&&("number"!=typeof t.opOutcome||t.opOutcome<0))return c("Wrong transaction "+e+". opIncome and opOutcome should be null or non-negative");if(void 0!==t.latitude&&("number"!=typeof t.latitude||Math.abs(t.latitude)>90)||void 0!==t.longitude&&("number"!=typeof t.longitude||Math.abs(t.longitude)>180))return c("Wrong transaction "+e+" coordinates");if(void 0!==t.date&&null===s(t.date))return c("Wrong transaction "+e+". Wrong date format");if(void 0!==t.mcc&&("number"!=typeof t.mcc||Math.floor(t.mcc)!==t.mcc))return c("Wrong transaction "+e+". MCC should be null or integer");if("string"!=typeof t.incomeAccount||0===t.incomeAccount.length||"string"!=typeof t.outcomeAccount||0===t.outcomeAccount.length)return c("Wrong transaction "+e+". Transaction should have incomeAccount and outcomeAccount of string type");if(t.incomeAccount===t.outcomeAccount&&t.income>0&&t.outcome>0)return c("Wrong transaction "+e+". Transaction with incomeAccount == outcomeAccount should have income == 0 or outcome == 0");if(t.incomeAccount!==t.outcomeAccount&&(0==t.income||0==t.outcome))return c("Wrong transaction "+e+". Transfer transaction with incomeAccount != outcomeAccount should have income > 0 and outcome > 0");var n=f(t.incomeAccount),r=f(t.outcomeAccount);return n?r?void 0===n.id&&void 0===r.id?c("Wrong transaction "+e+". Transaction should have at least incomeAccount or outcomeAccount added"):void 0:c("Wrong transaction "+e+". Cann't find outcomeAccount "+t.outcomeAccount):c("Wrong transaction "+e+". Cann't find incomeAccount "+t.incomeAccount)}var p="zenplugin-",d=this,g=e||{},m={},h=null;try{h=JSON.parse(getFileData(t.zp_data))||{}}catch(y){h={}}var v=!0,b=null,A=null,I=!1,O=null;this.getLevel=function(){return 12},this.Error=ZPAPIError,this.trace=function(e,n){console.log("[ZP "+t.id+"]: ["+(n||"trace")+"]",e)},this.setExceptions=function(t){v=t},this.setDefaultCharset=function(t){b=t},this.getLastError=function(){return A},this.isAvailable=function(){return!0},this.isSetResultCalled=function(){return I},this.getPreferences=function(){return g},this.setOptions=function(){},this.setAuthentication=function(t,e,n){},this.clearAuthentication=function(){},this.getCookies=function(){return[]},this.getCookie=function(){return null},this.setCookie=function(){},this.getData=function(t,e){return void 0!==h[t]?h[t]:e},this.setData=function(t,e){h[t]=e},this.clearData=function(){h={}},this.saveData=function(){d.trace("saveData:\n"+JSON.stringify(h)+"\n\nДля того, чтобы плагин мог использовать эти данные при следующем запуске, сохраните их в файл zp_data.txt\n")},this.saveCookies=function(){},this.restoreCookies=function(){},this.setResult=function(t){if(!I){if("object"!=typeof t)return void c("Wrong result object");I=!0,t.success?(d.trace("setResult success: "+JSON.stringify(t)),d.addAccount(t.account),d.addTransaction(t.transaction),A=null):(A=t.message?t.message.toString():null,d.trace("setResult fail: "+new ZPAPIError(A,!!t.allow_retry))),postMessage("close")}},this.getLastStatusString=function(){return O?"HTTP/1.1 "+O.status+" "+O.statusText:null},this.getLastStatusCode=function(){return O?O.status:0},this.getLastResponseHeader=function(t){var e=null;return O&&(e=O.getResponseHeader(p+t)||O.getResponseHeader(t)),e},this.getLastResponseHeaders=function(){if(!O)return null;for(var t=O.getAllResponseHeaders().split("\n"),e=[],n=0;n<t.length;n++){var r=t[n].indexOf(":"),o=[t[n].substring(0,r).replace(p,"").trim(),t[n].substring(r+2)];o[0].length>0&&e.push(o)}return e},this.getLastUrl=function(){return O?O.responseURL:null},this.getLastResponseParameters=function(){return O?{url:d.getLastUrl(),status:d.getLastStatusString(),headers:d.getLastResponseHeaders()}:null},this.addAccount=function(t){if(t){n(t)||(t=[t]);for(var e=0;e<t.length;e++){var r=t[e];if("object"!=typeof r||n(r))return c("Wrong account object. It should be {} object or array of objects");var o=r.id;if(!r.id||"string"!=typeof r.id||0===r.id.length)return c("Wrong account "+o+". Account should have id");if(!r.title||"string"!=typeof r.title||0===r.title.length)return c("Wrong account "+o+". Account should have title");if(r.type&&"string"==typeof r.type&&r.type.length>0){if(["card","ccard","checking","loan","deposit"].indexOf(r.type.toLowerCase())<0)return c("Wrong account "+o+". Account should have type 'card' or 'checking' or 'deposit' or 'loan'")}else r.type="ccard";if(void 0!==r.balance&&"number"!=typeof r.balance||void 0!==r.startBalance&&"number"!=typeof r.startBalance||void 0!==r.creditLimit&&"number"!=typeof r.creditLimit)return c("Wrong account "+o+". Account balance, startBalance, creditLimit fields should not be set or be numbers");var u=r.syncID,f=0;n(u)||(u=[u]);for(var l=0;l<u.length;l++){var p=u[l];if("string"!=typeof p&&(p="number"==typeof p||"boolean"==typeof p?p.toString():""),p=a(p),0==p.length)return c("Wrong account "+o+". Wrong syncID in account. It should be string or string array");f++}if(0==f)return c("Wrong account "+o+". Account should have syncID");if(("loan"===r.type||"deposit"===r.type)&&(r.startDate=s(r.startDate),r.payoffInterval=i(r.payoffInterval),r.endDateOffsetInterval=i(r.endDateOffsetInterval),"number"!=typeof r.percent||"boolean"!=typeof r.capitalization||"number"!=typeof r.endDateOffset||"number"!=typeof r.payoffStep||null===r.startDate||null===r.endDateOffsetInterval||Math.floor(r.payoffStep)!==r.payoffStep||Math.floor(r.endDateOffset)!==r.endDateOffset||r.endDateOffset<=0||r.payoffStep<0||r.payoffStep>0&&null===r.payoffInterval||0==r.payoffStep&&r.payoffInterval))return c("Wrong account "+o+" deposit or loan parameters");m[r.id]={id:r.id}}}},this.addTransaction=function(t){if(t){n(t)||(t=[t]);for(var e=0;e<t.length;e++){var r=t[e];if("object"!=typeof r||n(r))return c("Wrong transaction object. It should be {} object or array of objects");if(!l(r))return}}},this.retrieveCode=function(e,n,o){d.trace(e+"\n\nВведите код в файл zp_pipe.txt "+t.zp_pipe);for(var a=(o&&o.time?o.time:0)||6e4;a>0;){var i;try{i=getFileData(t.zp_pipe)}catch(s){i=null}if(i)return i;r(1e3),a-=1e3}return null},this.requestGet=function(t,e,n){return u("GET",t,e,null)},this.requestPost=function(t,e,n,r){return u("POST",t,n,e)}}var manifest=JSON.parse(e.data);manifest.zp_pipe=manifest.preferences.zp_pipe,manifest.zp_data=manifest.preferences.zp_data,manifest.zp_plugin_directory=manifest.preferences.zp_plugin_directory,delete manifest.preferences.zp_pipe,delete manifest.preferences.zp_data,delete manifest.preferences.zp_plugin_directory;var AnyBalance,ZenMoney;ZenMoney=AnyBalance=new ZPAPI(manifest,manifest.preferences);try{for(var i=0;i<manifest.files.length;i++)eval(getFileData("file://"+manifest.zp_plugin_directory+"/"+manifest.files[i]));main()}catch(e){throw ZPAPIError(e)}}
</script>
<script type="text/javascript">
    function getFileData(e,n){return new Promise(function(t,r){var i=new XMLHttpRequest;i.open("GET",e,!0),i.onerror=function(e){r(n||e)},i.onload=function(){t(this.responseText)},i.send()})}function getManifest(e){return new Promise(function(n,t){var r;try{r=(new DOMParser).parseFromString(e,"text/xml").documentElement}catch(i){r=null}if(!r||"provider"!==r.nodeName)return t("Wrong root object in ZenmoneyManifest.xml");for(var o={},s=r.children,a=0;a<s.length;a++){var c=s[a].nodeName;if("files"!==c)o[c]=s[a].innerHTML;else for(var l=s[a].children,f=0;f<l.length;f++)c=l[f].nodeName,"preferences"===c?o.preferences=l[f].innerHTML:(o.files||(o.files=[]),o.files.push(l[f].innerHTML))}return o.id&&o.build&&o.files&&o.version?void n(o):t("Wrong ZenmoneyManifest.xml")})}function runPlugin(e){var n=document.getElementsByTagName("script"),t=n[n.length-2].text,r=URL.createObjectURL(new Blob(["(",t,")()"],{type:"application/javascript"})),i=new Worker(r);i.postMessage(JSON.stringify(e)),i.onmessage=function(e){!e||"close"!==e&&"close"!==e.data||i.terminate()},URL.revokeObjectURL(r)}window.onload=function(){var e=window.location.href.substring(0,window.location.href.lastIndexOf("/")),n=null,t=e+"/zp_preferences.json";getFileData(t,"Put zp_preferences.json file in the same directory as this html").then(function(r){return new Promise(function(i,o){try{n=JSON.parse(r)}catch(s){return o("zp_preferences.json "+t+" parsing error: "+s)}return n.zp_plugin_directory?(n.zp_pipe=e+"/zp_pipe.txt",n.zp_data=e+"/zp_data.txt",i(n.zp_plugin_directory)):o("zp_preferences.json "+t+" should contain 'zp_plugin_directory' field")})}).then(function(e){return getFileData(e+"/ZenmoneyManifest.xml","Can't find ZenmoneyManifest.xml in "+e)}).then(getManifest).then(function(e){e.preferences=n,runPlugin(e)})["catch"](function(e){console.error(e)})};
</script>
</head>
<body>
<p><strong>Zenmoney Plugin debugger</strong></p>
</body>
</html>